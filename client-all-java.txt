===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ClientMain.java =====
package com.example.chess.client;

import com.example.chess.client.controller.ClientController;
import com.example.chess.client.net.ClientConnection;
import com.example.chess.client.view.ConsoleView;

import java.io.IOException;
import java.util.Scanner;

public class ClientMain {
    public static void main(String[] args) {
        String host = args.length > 0 ? args[0] : "localhost";
        int port = args.length > 1 ? Integer.parseInt(args[1]) : 5000;

        ConsoleView view = new ConsoleView(new Scanner(System.in), System.out);

        try {
            ClientConnection connection = new ClientConnection(host, port, null);
            connection.start();

            ClientController controller = new ClientController(connection, view);
            controller.run();

        } catch (IOException e) {
            System.err.println("Failed to connect to server: " + e.getMessage());
        }
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ClientMessageListener.java =====
package com.example.chess.client;

import com.example.chess.common.proto.StatusMessage;

public interface ClientMessageListener {
    void onMessage(StatusMessage msg);
}


===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\SessionState.java =====
package com.example.chess.client;

import com.example.chess.common.UserModels.User;

public class SessionState {
    private User user;
    private String activeGameId;
    private boolean inGame;
    private boolean isWhite;

    private String lastBoard;

    public String getLastBoard() { return lastBoard; }
    public void setLastBoard(String lastBoard) { this.lastBoard = lastBoard; }

    public User getUser() { return user; }
    public void setUser(User user) { this.user = user; }

    public String getActiveGameId() { return activeGameId; }
    public void setActiveGameId(String activeGameId) { this.activeGameId = activeGameId; }

    public boolean isInGame() { return inGame; }
    public void setInGame(boolean inGame) { this.inGame = inGame; }

    public boolean isWhite() { return isWhite; }
    public void setWhite(boolean white) { isWhite = white; }

    public void clearGame() {
        this.activeGameId = null;
        this.inGame = false;
        this.isWhite = false;
        this.lastBoard = null;
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\controller\ClientController.java =====
package com.example.chess.client.controller;

import com.example.chess.client.SessionState;
import com.example.chess.client.net.ClientConnection;
import com.example.chess.client.ui.AuthScreen;
import com.example.chess.client.ui.InGameScreen;
import com.example.chess.client.ui.LobbyScreen;
import com.example.chess.client.view.ConsoleView;
import com.example.chess.common.proto.ResponseMessage;

import java.util.Map;

public class ClientController {

    private final ClientConnection conn;
    private final ConsoleView view;
    private final SessionState state = new SessionState();

    public ClientController(ClientConnection conn, ConsoleView view) {
        this.conn = conn;
        this.view = view;

        // push handler
        this.conn.setPushHandler(this::onPush);
    }

    public void run() {
        while (true) {
            new AuthScreen(conn, view, state).show();
            new LobbyScreen(conn, view, state).show();
            if (state.isInGame()) new InGameScreen(conn, view, state).show();
        }
    }

    private void onPush(ResponseMessage msg) {
        if (msg == null) return;

        Map<String, Object> p = (msg.payload != null) ? msg.payload : Map.of();

        switch (msg.type) {
            case "gameStarted" -> {
                String gameId = asString(p, "gameId");
                String color = asString(p, "color");
                String opponent = asString(p, "opponent");
                boolean resumed = asBool(p, "resumed", false);

                if (gameId != null) state.setActiveGameId(gameId);
                state.setInGame(true);
                state.setWhite("white".equalsIgnoreCase(color));

                view.showMessage((resumed ? "Resumed" : "Game started")
                        + " vs " + opponent
                        + ". You are " + (state.isWhite() ? "WHITE" : "BLACK")
                        + ". GameId=" + gameId);

                String boardStr = asString(p, "board");
                if (boardStr != null && !boardStr.isBlank()) {
                    state.setLastBoard(boardStr);
                    view.showBoard(boardStr);
                }
            }

            case "move" -> {
                String moveStr = asString(p, "move");
                boolean whiteInCheck = asBool(p, "whiteInCheck", false);
                boolean blackInCheck = asBool(p, "blackInCheck", false);

                if (moveStr != null) {
                    view.showMove(moveStr, whiteInCheck, blackInCheck);
                }

                String boardStr = asString(p, "board");
                if (boardStr != null && !boardStr.isBlank()) {
                    state.setLastBoard(boardStr);
                    view.showBoard(boardStr);
                }
            }

            case "drawOffered" ->
                    view.showMessage("Draw offered by: " + asString(p, "by"));

            case "drawDeclined" ->
                    view.showMessage("Draw declined by: " + asString(p, "by"));

            case "gameOver" -> {
                view.showMessage("Game over: " + asString(p, "result")
                        + " reason=" + asString(p, "reason"));
                state.clearGame(); // make sure clearGame() clears lastBoard too
            }

            case "info" ->
                    view.showMessage(asString(p, "message"));

            case "error" ->
                    view.showError(msg.message != null ? msg.message : asString(p, "message"));

            default ->
                    view.showMessage("Push: " + msg.type + " " + p);
        }
    }

    private static String asString(Map<String, Object> p, String k) {
        Object v = p.get(k);
        return v == null ? null : String.valueOf(v);
    }

    private static boolean asBool(Map<String, Object> p, String k, boolean def) {
        Object v = p.get(k);
        if (v == null) return def;
        if (v instanceof Boolean b) return b;
        return Boolean.parseBoolean(String.valueOf(v));
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\model\ClientModel.java =====
package com.example.chess.client.model;

import com.example.chess.common.UserModels.User;
import com.example.chess.common.model.Game;

import java.util.ArrayList;
import java.util.List;

public class ClientModel {

    private User currentUser;

    private String activeGameId;

    // extra context for UX
    private boolean playingAsWhite;
    private String opponent;

    private List<Game> myGames = new ArrayList<>();

    private String lastBoard;

    public String getLastBoard() { return lastBoard; }
    public void setLastBoard(String board) { this.lastBoard = board; }

    public User getCurrentUser() {
        return currentUser;
    }

    public void setCurrentUser(User currentUser) {
        this.currentUser = currentUser;
    }

    public boolean isLoggedIn() {
        return currentUser != null;
    }

    public String getActiveGameId() {
        return activeGameId;
    }

    public void setActiveGameId(String gameId) {
        this.activeGameId = gameId;
    }

    public void clearActiveGame() {
        this.activeGameId = null;
        this.playingAsWhite = false;
        this.opponent = null;
        this.lastBoard = null;
    }

    public boolean hasActiveGame() {
        return activeGameId != null;
    }

    public boolean isPlayingAsWhite() {
        return playingAsWhite;
    }

    public String getOpponent() {
        return opponent;
    }

    public void setGameContext(boolean playingAsWhite, String opponent) {
        this.playingAsWhite = playingAsWhite;
        this.opponent = opponent;
    }

    public List<Game> getMyGames() {
        return myGames;
    }

    public void setMyGames(List<Game> myGames) {
        this.myGames = (myGames != null ? myGames : new ArrayList<>());
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\net\ClientConnection.java =====
package com.example.chess.client.net;

import com.example.chess.client.ClientMessageListener;
import com.example.chess.common.MessageCodec;
import com.example.chess.common.proto.Message;
import com.example.chess.common.proto.RequestMessage;
import com.example.chess.common.proto.ResponseMessage;
import com.example.chess.common.proto.StatusMessage;

import java.io.*;
import java.net.Socket;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;
import java.util.function.Consumer;

public class ClientConnection {

    private final String host;
    private final int port;

    // legacy listener (StatusMessage-based)
    private volatile ClientMessageListener listener;

    // new push handler (ResponseMessage-based)
    private volatile Consumer<ResponseMessage> pushHandler = m -> {
    };

    private Socket socket;
    private BufferedReader in;
    private BufferedWriter out;
    private Thread readerThread;

    private final Map<String, CompletableFuture<StatusMessage>> pending = new ConcurrentHashMap<>();

    public ClientConnection(String host, int port, ClientMessageListener listener) {
        this.host = host;
        this.port = port;
        this.listener = listener;
    }

    public void start() throws IOException {
        socket = new Socket(host, port);
        in = new BufferedReader(new InputStreamReader(socket.getInputStream()));
        out = new BufferedWriter(new OutputStreamWriter(socket.getOutputStream()));

        readerThread = new Thread(this::readLoop, "client-reader");
        readerThread.setDaemon(true);
        readerThread.start();
    }

    public void setListener(ClientMessageListener listener) {
        this.listener = listener;
    }

    public void setPushHandler(Consumer<ResponseMessage> h) {
        this.pushHandler = (h == null) ? (m -> {
        }) : h;
    }

    private void readLoop() {
        try {
            String line;
            while ((line = in.readLine()) != null) {
                line = line.trim();
                if (line.isEmpty()) continue;

                Message msg = MessageCodec.fromJson(line);

                if (msg instanceof ResponseMessage resp) {
                    // correlated response -> complete the waiting future
                    if (resp.corrId != null) {
                        CompletableFuture<StatusMessage> fut = pending.remove(resp.corrId);
                        if (fut != null) {
                            fut.complete(StatusMessage.from(resp));
                            continue;
                        }
                    }

                    // async push -> deliver to pushHandler
                    Consumer<ResponseMessage> ph = pushHandler;
                    if (ph != null) ph.accept(resp);

                    // also keep legacy listener if present (optional)
                    ClientMessageListener l = listener;
                    if (l != null) l.onMessage(StatusMessage.from(resp));
                }
            }
        } catch (IOException e) {
            System.err.println("ClientConnection readLoop error: " + e.getMessage());
            e.printStackTrace();
            pending.values().forEach(f -> f.completeExceptionally(e));
            pending.clear();
        }
    }

    public CompletableFuture<StatusMessage> sendAndWait(RequestMessage msg) {
        String corrId = msg.corrId;
        if (corrId == null || corrId.isBlank()) {
            corrId = UUID.randomUUID().toString();
            msg = new RequestMessage(msg.type, corrId, msg.payload);
        }

        CompletableFuture<StatusMessage> fut = new CompletableFuture<>();
        pending.put(corrId, fut);

        try {
            String json = MessageCodec.toJson(msg); // includes trailing newline
            synchronized (out) {
                out.write(json);
                out.flush();
            }
        } catch (IOException e) {
            pending.remove(corrId);
            fut.completeExceptionally(e);
        }

        return fut;
    }

    public CompletableFuture<StatusMessage> login(String username, String password) {
        return sendAndWait(new RequestMessage("login", UUID.randomUUID().toString(),
                Map.of("username", username, "password", password)));
    }

    public CompletableFuture<StatusMessage> register(String username, String name, String password) {
        return sendAndWait(new RequestMessage("register", UUID.randomUUID().toString(),
                Map.of("username", username, "name", name, "password", password)));
    }

    public CompletableFuture<StatusMessage> requestGame() {
        return sendAndWait(new RequestMessage("requestGame", UUID.randomUUID().toString(), Map.of()));
    }

    public CompletableFuture<StatusMessage> makeMove(String gameId, String move) {
        return sendAndWait(new RequestMessage("makeMove", UUID.randomUUID().toString(),
                Map.of("gameId", gameId, "move", move)));
    }

    public CompletableFuture<StatusMessage> offerDraw(String gameId) {
        return sendAndWait(new RequestMessage("offerDraw", UUID.randomUUID().toString(),
                Map.of("gameId", gameId)));
    }

    public CompletableFuture<StatusMessage> resign(String gameId) {
        return sendAndWait(new RequestMessage("resign", UUID.randomUUID().toString(),
                Map.of("gameId", gameId)));
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\AuthScreen.java =====
package com.example.chess.client.ui;

import com.example.chess.client.SessionState;
import com.example.chess.client.net.ClientConnection;
import com.example.chess.client.ui.menu.Menu;
import com.example.chess.client.ui.menu.MenuItem;
import com.example.chess.client.view.ConsoleView;

public class AuthScreen implements Screen {

    private final ClientConnection conn;
    private final ConsoleView view;
    private final SessionState state;

    public AuthScreen(ClientConnection conn, ConsoleView view, SessionState state) {
        this.conn = conn;
        this.view = view;
        this.state = state;
    }

    @Override
    public void show() {
        Menu menu = new Menu("Auth");
        menu.add(new MenuItem("Login", new LoginCommand(conn, view, state)));
        menu.add(new MenuItem("Register", new RegisterCommand(conn, view)));
        menu.add(new MenuItem("Exit", () -> System.exit(0)));

        while (state.getUser() == null) {
            menu.render(view);
            menu.readAndExecute(view);
        }
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\InGameScreen.java =====
package com.example.chess.client.ui;

import com.example.chess.client.net.ClientConnection;
import com.example.chess.client.SessionState;
import com.example.chess.client.ui.menu.Command;
import com.example.chess.client.ui.menu.Menu;
import com.example.chess.client.ui.menu.MenuItem;
import com.example.chess.client.view.ConsoleView;

public class InGameScreen implements Screen {

    private final ClientConnection conn;
    private final ConsoleView view;
    private final SessionState state;

    public InGameScreen(ClientConnection conn, ConsoleView view, SessionState state) {
        this.conn = conn; this.view = view; this.state = state;
    }

    @Override
    public void show() {
        Menu menu = new Menu("Game");
        menu.add(new MenuItem("Move", new MoveCommand(conn, view, state)));
        menu.add(new MenuItem("Offer draw", new OfferDrawCommand(conn, view, state)));
        menu.add(new MenuItem("Resign", new ResignCommand(conn, view, state)));
        menu.add(new MenuItem("Back to lobby", () -> state.clearGame()));
        menu.add(new MenuItem("Print board", () -> view.showBoard(state.getLastBoard())));

        while (state.getUser() != null && state.isInGame()) {
            menu.render(view);
            menu.readAndExecute(view);
        }
    }

    static final class MoveCommand implements Command {
        private final ClientConnection conn;
        private final ConsoleView view;
        private final SessionState state;

        MoveCommand(ClientConnection conn, ConsoleView view, SessionState state) {
            this.conn = conn; this.view = view; this.state = state;
        }

        @Override public void execute() {
            String move = view.readLine("Enter move (e2e4 / e7e8q): ").trim();
            var status = conn.makeMove(state.getActiveGameId(), move).join();
            if (status.isError()) view.showError(status.getMessage());
            else view.showMessage("Move sent.");
        }
    }

    static final class OfferDrawCommand implements Command {
        private final ClientConnection conn;
        private final ConsoleView view;
        private final SessionState state;

        OfferDrawCommand(ClientConnection conn, ConsoleView view, SessionState state) {
            this.conn = conn; this.view = view; this.state = state;
        }

        @Override
        public void execute() {
            var status = conn.offerDraw(state.getActiveGameId()).join();
            if (status.isError()) view.showError(status.getMessage());
            else view.showMessage("Draw offer sent.");
        }
    }

    static final class ResignCommand implements Command {
        private final ClientConnection conn;
        private final ConsoleView view;
        private final SessionState state;

        ResignCommand(ClientConnection conn, ConsoleView view, SessionState state) {
            this.conn = conn; this.view = view; this.state = state;
        }

        @Override
        public void execute() {
            var status = conn.resign(state.getActiveGameId()).join();
            if (status.isError()) view.showError(status.getMessage());
            else view.showMessage("Resigned.");
        }
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\LobbyScreen.java =====
package com.example.chess.client.ui;

import com.example.chess.client.net.ClientConnection;
import com.example.chess.client.SessionState;
import com.example.chess.client.ui.menu.Command;
import com.example.chess.client.ui.menu.Menu;
import com.example.chess.client.ui.menu.MenuItem;
import com.example.chess.client.view.ConsoleView;

public class LobbyScreen implements Screen {

    private final ClientConnection conn;
    private final ConsoleView view;
    private final SessionState state;

    public LobbyScreen(ClientConnection conn, ConsoleView view, SessionState state) {
        this.conn = conn; this.view = view; this.state = state;
    }

    @Override
    public void show() {
        Menu menu = new Menu("Lobby");
        menu.add(new MenuItem("Request game", new RequestGameCommand(conn, view, state)));
        menu.add(new MenuItem("Logout", () -> { state.setUser(null); state.clearGame(); }));
        menu.add(new MenuItem("Exit", () -> System.exit(0)));

        while (state.getUser() != null && !state.isInGame()) {
            menu.render(view);
            menu.readAndExecute(view);
        }
    }

    static final class RequestGameCommand implements Command {
        private final ClientConnection conn;
        private final ConsoleView view;
        private final SessionState state;

        RequestGameCommand(ClientConnection conn, ConsoleView view, SessionState state) {
            this.conn = conn; this.view = view; this.state = state;
        }

        @Override public void execute() {
            var status = conn.requestGame().join();
            if (status.isError()) view.showError(status.getMessage());
            else view.showMessage("Queued / matched. Waiting for server...");
        }
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\LoginCommand.java =====
package com.example.chess.client.ui;

import com.example.chess.client.SessionState;
import com.example.chess.client.net.ClientConnection;
import com.example.chess.client.ui.menu.Command;
import com.example.chess.client.view.ConsoleView;
import com.example.chess.common.UserModels;

import java.util.Map;

public class LoginCommand implements Command {

    private final ClientConnection conn;
    private final ConsoleView view;
    private final SessionState state;

    public LoginCommand(ClientConnection conn, ConsoleView view, SessionState state) {
        this.conn = conn;
        this.view = view;
        this.state = state;
    }

    @Override
    public void execute() {
        String u = view.askLine("Username: ").trim();
        String p = view.askLine("Password: ").trim();

        var status = conn.login(u, p).join();
        if (status.isError()) {
            view.showError(status.getMessage());
            return;
        }

        Object userObj = status.payload != null ? status.payload.get("user") : null;
        if (!(userObj instanceof Map<?, ?> um)) {
            view.showError("Login OK, but missing user payload.");
            return;
        }

        UserModels.User user = new UserModels.User();
        user.username = str(um.get("username"));
        user.name = str(um.get("name"));

        UserModels.Stats st = new UserModels.Stats();
        st.played = intVal(um.get("played"));
        st.won = intVal(um.get("won"));
        st.drawn = intVal(um.get("drawn"));
        st.rating = intVal(um.get("rating"));
        user.stats = st;

        state.setUser(user);
        view.showMessage("Logged in as " + user.username);
    }

    private static String str(Object o) {
        return o == null ? "" : String.valueOf(o);
    }

    private static int intVal(Object o) {
        if (o == null) return 0;
        if (o instanceof Number n) return n.intValue();
        try { return Integer.parseInt(String.valueOf(o)); }
        catch (Exception e) { return 0; }
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\RegisterCommand.java =====
package com.example.chess.client.ui;

import com.example.chess.client.net.ClientConnection;
import com.example.chess.client.ui.menu.Command;
import com.example.chess.client.view.ConsoleView;

public class RegisterCommand implements Command {

    private final ClientConnection conn;
    private final ConsoleView view;

    public RegisterCommand(ClientConnection conn, ConsoleView view) {
        this.conn = conn;
        this.view = view;
    }

    @Override
    public void execute() {
        String username = view.askLine("Username: ").trim();
        String name = view.askLine("Name: ").trim();
        String pass = view.askLine("Password: ").trim(); // Р°РєРѕ РЅСЏРјР° readPassword

        var status = conn.register(username, name, pass).join();
        if (status.isError()) view.showError(status.getMessage());
        else view.showMessage("Registered successfully.");
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\Screen.java =====
package com.example.chess.client.ui;

public interface Screen {
    void show();
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\menu\Command.java =====
package com.example.chess.client.ui.menu;

@FunctionalInterface
public interface Command {
    boolean execute();
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\menu\Menu.java =====
package com.example.chess.client.ui.menu;

import com.example.chess.client.view.ConsoleView;

import java.util.ArrayList;
import java.util.List;

public class Menu {
    private final String title;
    private final List<MenuItem> items = new ArrayList<>();

    public Menu(String title) {
        this.title = title;
    }

    public void add(MenuItem item) {
        items.add(item);
    }

    public void render(ConsoleView view) {
        view.showMessage("\n=== " + title + " ===");
        for (int i = 0; i < items.size(); i++) {
            view.showMessage((i + 1) + ") " + items.get(i).getLabel());
        }
    }

    public void readAndExecute(ConsoleView view) {
        int choice = view.askInt("Choose: ");
        if (choice < 1 || choice > items.size()) {
            view.showError("Invalid choice.");
            return;
        }
        items.get(choice - 1).getCommand().execute();
    }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\ui\menu\MenuItem.java =====
package com.example.chess.client.ui.menu;

public class MenuItem {
    private final String label;
    private final Command command;

    public MenuItem(String label, Command command) {
        this.label = label;
        this.command = command;
    }

    public String getLabel() { return label; }
    public Command getCommand() { return command; }
}

===== FILE: D:\BL\Chess\Chess\client\src\main\java\com\example\chess\client\view\ConsoleView.java =====
package com.example.chess.client.view;

import java.io.PrintStream;
import java.util.Scanner;

public class ConsoleView {

    private final Scanner in;
    private final PrintStream out;

    public ConsoleView(Scanner in, PrintStream out) {
        this.in = in;
        this.out = out;
    }

    public String askLine(String prompt) {
        out.print(prompt);
        return in.nextLine();
    }

    public void showMessage(String msg) {
        out.println(msg);
    }

    public void showError(String msg) {
        out.println("[ERROR] " + msg);
    }

    public void showMove(String move, boolean whiteInCheck, boolean blackInCheck) {
        out.printf("Move played: %s%n", move);
        if (whiteInCheck) out.println("White is in check.");
        if (blackInCheck) out.println("Black is in check.");
    }

    public void showGameOver(String result, String reason) {
        out.printf("Game over: %s (%s)%n", result, reason);
    }

    public int askInt(String prompt) {
        while (true) {
            out.print(prompt);
            String line = in.nextLine().trim();
            try {
                return Integer.parseInt(line);
            } catch (NumberFormatException e) {
                out.println("Please enter a number.");
            }
        }
    }

    public void showBoard(String boardText) {
        if (boardText == null || boardText.isBlank()) {
            out.println("(no board)");
            return;
        }
        out.println(boardText);
    }
}

